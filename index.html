<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Evento Recorrente .ics</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input[type="text"],
        textarea,
        input[type="date"] {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s ease;
            width: 100%;
        }
        button:hover {
            background-color: #2980b9;
        }
        .info {
            font-size: 0.9em;
            color: #777;
            margin-top: 15px;
            padding: 10px;
            background-color: #e9f5fd;
            border-left: 3px solid #3498db;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gerador de Evento Semanal Recorrente</h1>
        
        <div class="form-group">
            <label for="eventName">Nome do Evento:</label>
            <input type="text" id="eventName" value="Semana de Leitura Programada">
        </div>

        <div class="form-group">
            <label for="eventDescription">Observação (Descrição):</label>
            <textarea id="eventDescription">Memorização de versículos e leitura diária.</textarea>
        </div>

        <div class="form-group">
            <label for="startDate">Data de Início da Primeira Semana (selecione qualquer dia, o sistema ajustará para a próxima segunda-feira):</label>
            <input type="date" id="startDate">
        </div>

        <button onclick="generateICS()">Gerar Arquivo .ics</button>

        <div class="info">
            <p><strong>Como funciona:</strong></p>
            <ul>
                <li>O evento será configurado para durar o dia todo, de Segunda a Domingo.</li>
                <li>Ele se repetirá a cada 3 semanas.</li>
                <li>Este padrão de repetição (uma semana de evento a cada 3 semanas) ocorrerá 3 vezes no total.</li>
            </ul>
        </div>
    </div>

    <script>
        function formatDateToICS(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function formatDateTimeToICS(date) {
            const year = date.getUTCFullYear();
            const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
            const day = date.getUTCDate().toString().padStart(2, '0');
            const hours = date.getUTCHours().toString().padStart(2, '0');
            const minutes = date.getUTCMinutes().toString().padStart(2, '0');
            const seconds = date.getUTCSeconds().toString().padStart(2, '0');
            return `${year}${month}${day}T${hours}${minutes}${seconds}Z`;
        }

        function generateICS() {
            const eventName = document.getElementById('eventName').value.trim();
            const eventDescription = document.getElementById('eventDescription').value.trim();
            const startDateInput = document.getElementById('startDate').value;

            if (!eventName) {
                alert("Por favor, insira o nome do evento.");
                return;
            }
            if (!startDateInput) {
                alert("Por favor, selecione uma data de início.");
                return;
            }

            // Parse the user-selected date. It's local time.
            const userSelectedDate = new Date(startDateInput + 'T00:00:00'); // Ensure it's parsed as local midnight

            // Find the first Monday on or after the userSelectedDate
            let firstMonday = new Date(userSelectedDate.getTime());
            while (firstMonday.getDay() !== 1) { // 0=Sun, 1=Mon, ..., 6=Sat
                firstMonday.setDate(firstMonday.getDate() + 1);
            }

            const dtStart = new Date(firstMonday.getTime());
            const dtEnd = new Date(firstMonday.getTime());
            dtEnd.setDate(dtEnd.getDate() + 7); // Event ends after 7 days (Mon to Sun), so DTEND is the next Monday

            const uid = Date.now() + "@yourdomain.com"; // Simple unique ID
            const dtStamp = formatDateTimeToICS(new Date());

            const icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//MeuGerador//Evento Semanal//PT',
                'BEGIN:VEVENT',
                `UID:${uid}`,
                `DTSTAMP:${dtStamp}`,
                `DTSTART;VALUE=DATE:${formatDateToICS(dtStart)}`,
                `DTEND;VALUE=DATE:${formatDateToICS(dtEnd)}`,
                `SUMMARY:${eventName.replace(/,/g, '\\,').replace(/\n/g, '\\n')}`,
                `DESCRIPTION:${eventDescription.replace(/,/g, '\\,').replace(/\n/g, '\\n')}`,
                // RRULE: Repeats weekly, interval of 3 weeks, for a total of 3 occurrences.
                // The event itself is defined from DTSTART to DTEND (1 week).
                // This 1-week event will repeat.
                'RRULE:FREQ=WEEKLY;INTERVAL=3;COUNT=3', 
                'END:VEVENT',
                'END:VCALENDAR'
            ].join('\r\n');

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            // Sanitize filename
            const safeEventName = eventName.replace(/[^a-z0-9_]/gi, '_').toLowerCase();
            link.download = `${safeEventName || 'evento'}_recorrente.ics`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href); // Clean up
        }

        // Set a default start date for user convenience (e.g., next Monday)
        window.onload = function() {
            const today = new Date();
            let nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + (1 + 7 - today.getDay()) % 7); // Find next Monday (or today if it's Monday)
            if (today.getDay() === 0) { // If today is Sunday, add 1 day to get to Monday
                nextMonday.setDate(today.getDate() + 1);
            } else if (today.getDay() !== 1) { // If not Sunday and not Monday, find next Monday
                 nextMonday.setDate(today.getDate() + (1 - today.getDay() + 7) % 7);
            }
             // If today is Monday, it will correctly use today.
            
            // If today is Monday and we want the *next* Monday if the user means "starting next week"
            // we might need to adjust. But current logic: "first Monday on or *after* today"
            // So if today is Monday, it uses today. Let's ensure it's the *next* Monday if they pick today
            // to avoid confusion IF they mean "start the sequence next week".
            // However, the label says "próxima segunda-feira", so the current logic is fine.
            // Let's re-evaluate the default date setting to be truly the next Monday
            // even if today is Monday.
            
            let defaultStartDate = new Date();
            const dayOfWeek = defaultStartDate.getDay(); // 0 (Sun) to 6 (Sat)
            let daysUntilMonday = (1 - dayOfWeek + 7) % 7;
            if (daysUntilMonday === 0 && defaultStartDate.getHours() >= 0) { // If it's Monday today
                 // Do nothing, or add 7 if you always want *next* week's Monday
                 // For "próxima segunda", using today if it's Monday is fine.
            }
            defaultStartDate.setDate(defaultStartDate.getDate() + daysUntilMonday);


            document.getElementById('startDate').valueAsDate = defaultStartDate;
        };
    </script>
</body>
</html>
